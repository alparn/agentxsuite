# ===== AgentxSuite Landing Page - Apache Configuration =====
# Domain: agentxsuite.com
# Cache handling: Prevent caching of old files when new files are uploaded
#
# IMPORTANT: If CSS/JS files still return MIME type 'text/html':
# 1. Check if files exist on server: https://agentxsuite.com/assets/css/base.css
# 2. Check Apache error logs: /var/log/apache2/error.log
# 3. Verify mod_rewrite is enabled: apache2ctl -M | grep rewrite
# 4. Check if AllowOverride is set to All in Apache config
# 5. Check if there's another .htaccess in parent directories
# 6. Check if hosting provider has server-level redirects that override .htaccess

# ===== MIME Types (MUST BE FIRST) =====
<IfModule mod_mime.c>
    # CSS
    AddType text/css css
    
    # JavaScript
    AddType application/javascript js
    AddType application/json json

    # Fonts
    AddType font/woff woff
    AddType font/woff2 woff2
    AddType font/ttf ttf
    AddType font/otf otf
    AddType font/eot eot

    # Images
    AddType image/svg+xml svg svgz
    AddType image/webp webp
    AddType image/png png
    AddType image/jpeg jpg jpeg
    AddType image/gif gif
    AddType image/x-icon ico

    # Web App Manifest
    AddType application/manifest+json webmanifest
    
    # XML
    AddType application/xml xml
    AddType text/xml xml
    AddType application/rss+xml rss
    AddType application/atom+xml atom
</IfModule>

# ===== Enable Rewrite Engine =====
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # CRITICAL: FIRST - Don't rewrite static assets (CSS, JS, images, fonts, etc.)
    # This MUST be the first rule to prevent any redirects to index.html
    # Match any request that ends with a static file extension
    RewriteCond %{REQUEST_URI} \.(css|js|jpg|jpeg|png|gif|webp|svg|ico|woff|woff2|ttf|otf|eot|json|xml|rss|atom|webmanifest|txt|pdf|zip)$ [NC]
    RewriteRule ^ - [L]

    # CRITICAL: SECOND - Don't rewrite requests for existing files and directories
    # This prevents CSS/JS/images from being redirected to index.html
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # CRITICAL: THIRD - Don't rewrite requests in assets directory
    # Extra safety check for assets folder
    RewriteCond %{REQUEST_URI} ^/assets/ [NC]
    RewriteRule ^ - [L]

    # Force HTTPS (uncomment when SSL is configured)
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Force www or non-www (choose one)
    # RewriteCond %{HTTP_HOST} !^www\.agentxsuite\.com$ [NC]
    # RewriteRule ^(.*)$ https://www.agentxsuite.com/$1 [L,R=301]
    
    # Or force non-www
    # RewriteCond %{HTTP_HOST} ^www\.agentxsuite\.com$ [NC]
    # RewriteRule ^(.*)$ https://agentxsuite.com/$1 [L,R=301]
</IfModule>

# ===== Cache Control Headers =====
<IfModule mod_headers.c>
    # CRITICAL: Set Content-Type header explicitly for CSS and JS (prevent MIME type issues)
    # This overrides any server defaults that might set text/html
    <FilesMatch "\.css$">
        Header set Content-Type "text/css; charset=UTF-8"
        Header unset Content-Type
        Header set Content-Type "text/css; charset=UTF-8"
    </FilesMatch>
    
    <FilesMatch "\.js$">
        Header set Content-Type "application/javascript; charset=UTF-8"
        Header unset Content-Type
        Header set Content-Type "application/javascript; charset=UTF-8"
    </FilesMatch>
    
    <FilesMatch "\.svg$">
        Header set Content-Type "image/svg+xml; charset=UTF-8"
    </FilesMatch>
    
    <FilesMatch "\.json$">
        Header set Content-Type "application/json; charset=UTF-8"
    </FilesMatch>
    
    # HTML files - No cache to ensure fresh content after uploads
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
        Header set Expires "0"
        Header unset ETag
    </FilesMatch>

    # XML files (sitemap, feed) - Short cache, revalidate
    <FilesMatch "\.(xml|rss|atom)$">
        Header set Cache-Control "public, max-age=3600, must-revalidate"
        Header set Expires "now plus 1 hour"
    </FilesMatch>

    # CSS and JavaScript - Long cache with versioning (cache-busting via filename)
    # These should be versioned in filenames (e.g., main.v1.2.3.js)
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set Expires "now plus 1 year"
    </FilesMatch>

    # Images - Long cache for static images
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set Expires "now plus 1 year"
    </FilesMatch>

    # Fonts - Long cache
    <FilesMatch "\.(woff|woff2|ttf|otf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set Expires "now plus 1 year"
    </FilesMatch>

    # JSON files (i18n) - Short cache, revalidate
    <FilesMatch "\.json$">
        Header set Cache-Control "public, max-age=3600, must-revalidate"
        Header set Expires "now plus 1 hour"
    </FilesMatch>

    # Manifest and other config files - No cache
    <FilesMatch "\.(webmanifest|txt)$">
        Header set Cache-Control "no-cache, must-revalidate"
        Header set Pragma "no-cache"
    </FilesMatch>

    # Remove ETags (use Cache-Control instead)
    Header unset ETag
    FileETag None
</IfModule>

# ===== Compression (Gzip) =====
<IfModule mod_deflate.c>
    # Compress HTML, CSS, JavaScript, Text, XML and fonts
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/atom+xml
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/woff
    AddOutputFilterByType DEFLATE font/woff2

    # Remove browser bugs (only needed for really old browsers)
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
</IfModule>

# MIME Types are now defined at the top (before RewriteEngine)

# ===== Security Headers =====
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"

    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"

    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Content Security Policy (adjust as needed)
    # Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:;"

    # Permissions Policy (formerly Feature Policy)
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# ===== File Access Restrictions =====
# Protect sensitive files
<FilesMatch "^(\.htaccess|\.htpasswd|\.git|\.gitignore|\.env|README\.md|serve\.py)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# ===== Directory Index =====
DirectoryIndex index.html index.htm

# ===== Error Pages (Optional) =====
# ErrorDocument 404 /404.html
# ErrorDocument 500 /500.html

# ===== UTF-8 Encoding =====
AddDefaultCharset UTF-8
<IfModule mod_mime.c>
    AddCharset UTF-8 .html .css .js .xml .json .rss .atom
</IfModule>

# ===== Disable Directory Browsing =====
Options -Indexes

# ===== Prevent Access to Hidden Files =====
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

